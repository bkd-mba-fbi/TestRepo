name: Retire.js CVE Scan mit E-Mail

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan-and-mail:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Retire.js
        run: npm install -g retire

      - name: Run Retire.js and create report
        run: |
          retire --path . --outputformat json --outputpath retire-report.json || true
          node <<'EOF'
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('retire-report.json', 'utf8'));
          if (report.data.length === 0) {
            fs.writeFileSync('mail.txt', '‚úÖ Keine Schwachstellen gefunden.');
            return;
          }
          let out = `üö® Retire.js Schwachstellen gefunden:\n\n`;
          report.data.forEach(entry => {
            out += `üìÑ Datei: ${entry.file}\n`;
            entry.results.forEach(res => {
              out += `- üì¶ ${res.component} (${res.version})\n`;
              res.vulnerabilities.forEach(v => {
                out += `  ‚ö†Ô∏è ${v.severity || 'Unbekannt'} ‚Äì ${v.identifiers?.CVE?.join(', ') || v.info?.join(', ')}\n`;
              });
            });
            out += `\n`;
          });
          fs.writeFileSync('mail.txt', out);
          EOF

      - name: Send Email Report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: mailrelay.svc.kb-bedag.ch
          server_port: 25
          secure: false
          subject: "üö® Retire.js Scan Report"
          to: walid.boulhazayez@be.ch
          from: fbi.mba@be.ch
          content_type: text/plain
          body_file: mail.txt
