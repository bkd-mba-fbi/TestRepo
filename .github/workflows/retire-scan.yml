name: Retire.js Security Scan

on:
  push:
    branches: [ main ]
  pull_request:

permissions:                         
  contents: read                   
  security-events: write            

jobs:
  retirejs-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install retire.js
        run: npm install -g retire

      - name: Run Retire.js and create JSON
        run: |
          mkdir -p reports
          retire --outputformat json --outputpath reports/retire-report.json || true

      - name: Convert JSON to SARIF
        run: |
          node .github/scripts/convert-retire-json-to-sarif.js > reports/retire-report.sarif

      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: reports/retire-report.sarif
