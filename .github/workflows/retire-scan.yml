name: Retire.js Scan

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 7 * * 1'  # Montags 07:00

permissions:
  contents: read
  security-events: write  # ❗ notwendig für upload-sarif

jobs:
  retire:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Retire.js
        run: npm install -g retire

      - name: Run Retire.js scan
        run: retire --path . --outputformat json --outputpath retire-report.json || true

      - name: Convert Retire.js JSON to SARIF
        run: |
          node .github/scripts/retire-to-sarif.js

      - name: Upload SARIF to GitHub Code Scanning Alerts
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: retire-report.sarif
